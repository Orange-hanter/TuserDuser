<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</title>
    <style>
      :root {
        --primary: #0069ed;
        --bg: #fafafa;
        --text: #222;
        --modal-bg: rgba(0, 0, 0, 0.5);
      }
      body {
        font-family: system-ui, sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 0;
      }
      main {
        max-width: 600px;
        margin: 0 auto;
        padding: 1rem;
      }
      h2,
      h3 {
        text-align: center;
      }

      /* --- —à–∞–≥–∏ —Å–≤–µ—Ä—Ö—É --- */
      .steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        overflow-x: auto;
      }
      .step-indicator {
        flex: 1;
        text-align: center;
        font-size: 0.8rem;
        position: relative;
        color: #aaa;
      }
      .step-indicator.active {
        color: var(--primary);
        font-weight: bold;
      }
      .step-indicator::before {
        content: "";
        display: block;
        width: 24px;
        height: 24px;
        margin: 0 auto 0.25rem;
        border-radius: 50%;
        background: #ccc;
      }
      .step-indicator.active::before {
        background: var(--primary);
      }

      .form-step {
        display: none;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .active-step {
        display: block;
        opacity: 1;
      }

      label {
        display: block;
        margin: 0.75rem 0 0.25rem;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 0.5rem;
        box-sizing: border-box;
        font-size: 1rem;
      }
      textarea {
        resize: vertical;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.5rem;
      }
      .grid button {
        background: #53a7d5;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1rem 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .grid button.active {
        border-color: var(--primary);
        background: #eef4ff;
        color: #000;
      }

      .actions {
        margin-top: 1rem;
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      button {
        padding: 0.6rem 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background: var(--primary);
        color: #fff;
        font-size: 1rem;
        flex: 1;
      }
      button.secondary {
        background: #ccc;
        color: #000;
      }
      .preview {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 1rem;
        background: #fff;
      }

      /**/
      /* –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ */
      .feedback-float {
        position: fixed;
        bottom: 16px;
        right: 16px;
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: 50px;
        padding: 0.8rem 1.4rem;
        font-size: 0.95rem;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        z-index: 1000;
        transition: background 0.2s, transform 0.2s;
      }

      /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –∏ –Ω–∞–∂–∞—Ç–∏–∏ */
      .feedback-float:hover {
        background: #0053ba;
        transform: translateY(-2px);
      }
      .feedback-float:active {
        transform: translateY(1px);
      }

      /* –ê–¥–∞–ø—Ç–∏–≤ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö (–±–æ–ª–µ–µ –∫—Ä—É–ø–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ) */
      @media (max-width: 480px) {
        .feedback-float {
          left: 50%;
          right: auto;
          transform: translateX(-50%);
          width: calc(100% - 40px);
          max-width: 320px;
          bottom: 12px;
          text-align: center;
          padding: 1rem;
          border-radius: 12px;
        }
      }

      /* --- –º–æ–¥–∞–ª–∫–∞ –¥–ª—è —Ñ–∏–¥–±–µ–∫–∞ --- */
      .modal {
        position: fixed;
        bottom: -100%;
        left: 0;
        width: 92%;
        max-width: 600px;
        margin: 0 auto;
        background: #fff;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
        padding: 1rem;
        transition: bottom 0.3s;
        z-index: 1000;
      }
      .modal.active {
        bottom: 0;
      }
      .modal h4 {
        margin-top: 0;
      }
      .modal textarea {
        height: 80px;
      }
      .modal button {
        margin-top: 0.5rem;
      }

      .modal-close {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: red;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
      }

      /* --- –∞–¥–∞–ø—Ç–∏–≤ --- */
      @media (max-width: 480px) {
        main {
          padding: 0.5rem;
        }
        .grid {
          grid-template-columns: repeat(2, 1fr);
        }
        button {
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <h2>–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h2>
      <div class="steps" id="steps">
        <div class="step-indicator active">1. –¢–∏–ø</div>
        <div class="step-indicator">2. –ö–æ–≥–¥–∞</div>
        <div class="step-indicator">3. –ì–¥–µ</div>
        <div class="step-indicator">4. –¶–µ–Ω–∞</div>
        <div class="step-indicator">5. –î–µ—Ç–∞–ª–∏</div>
        <div class="step-indicator">6. –ü—Ä–æ—Å–º–æ—Ç—Ä</div>
      </div>

      <button class="feedback-float" onclick="openFeedback(current+1)">
        üí¨ –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
    </button>

      <form id="form"></form>
    </main>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —Ñ–∏–¥–±–µ–∫–∞ -->
    <div class="modal" id="feedbackModal">
      <button class="modal-close" onclick="closeFeedback()">‚úñ</button>
      <h4>üí¨ –û—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤ –æ —à–∞–≥–µ <span id="modalStep"></span></h4>
      <textarea
        id="feedbackText"
        placeholder="–ß—Ç–æ –±—ã–ª–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ –∏–ª–∏ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å?"
      ></textarea>
      <input
        type="email"
        id="feedbackEmail"
        placeholder="Email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
      />
      <button onclick="sendFeedback()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <script>
      const form = document.getElementById("form");
      const steps = document.querySelectorAll(".step-indicator");
      const modal = document.getElementById("feedbackModal");
      const modalStep = document.getElementById("modalStep");
      const eventData = {};
      let current = 0;
      const eventTypes = [
        "–ö–æ–Ω—Ü–µ—Ä—Ç",
        "–¢–µ–∞—Ç—Ä",
        "–í—ã—Å—Ç–∞–≤–∫–∞",
        "–§–µ—Å—Ç–∏–≤–∞–ª—å",
        "–õ–µ–∫—Ü–∏—è",
        "–°–ø–æ—Ä—Ç",
        "–ö–∏–Ω–æ",
        "–î–µ—Ç—Å–∫–æ–µ",
        "–í—Å—Ç—Ä–µ—á–∞",
        "–ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
      ];

      // --- –®–∞–≥–∏ ---
      const stepTemplates = [
        () => `
        <h3>–¢–∏–ø –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ</h3>
        <div class="grid">
          ${eventTypes
            .map(
              (t) =>
                `<button type="button" class="${
                  eventData.type === t ? "active" : ""
                }" onclick="selectType('${t}', this)">${t}</button>`
            )
            .join("")}
        </div>
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</label>
        <input autofocus id="title" maxlength="80" placeholder="–ù–∞–ø—Ä.: –î–∂–∞–∑ –≤ –ø–∞—Ä–∫–µ">
        <small>–ö—Ä–∞—Ç–∫–æ –∏ —è—Å–Ω–æ</small>
        <div class="actions">
          <button type="button" onclick="nextStep()">–î–∞–ª–µ–µ</button>
        </div>
      `,
        () => `
        <h3>–ö–æ–≥–¥–∞</h3>
        <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
        <input type="datetime-local" id="start">
        <label>–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è <small>(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</small></label>
        <input type="datetime-local" id="end">
        <small> –∏–ª–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω—É—Ç—ã)</small>
        <input type="number" id="duration" placeholder="–ù–∞–ø—Ä.: 90" min=30 value=30>

        <div class="actions">
          <button type="button" class="secondary" onclick="prevStep()">–ù–∞–∑–∞–¥</button>
          <button type="button" onclick="nextStep()">–î–∞–ª–µ–µ</button>
        </div>
      `,
        () => `
        <h3>–ì–¥–µ</h3>
        <label>–ú–µ—Å—Ç–æ</label>
        <input id="place" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å">
        <div class="actions">
          <button type="button" class="secondary" onclick="prevStep()">–ù–∞–∑–∞–¥</button>
          <button type="button" onclick="nextStep()">–î–∞–ª–µ–µ</button>
        </div>
        `,
        () => `
        <h3>–¶–µ–Ω–∞ –∏ —É—á–∞—Å—Ç–∏–µ</h3>
        <label>–°—Ç–æ–∏–º–æ—Å—Ç—å</label>
        <select id="priceType" onchange="togglePrice()">
          <option value="free">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</option>
          <option value="paid">–ü–ª–∞—Ç–Ω–æ–µ</option>
        </select>
        <div id="priceFields" style="display:none;">
          <label>–¶–µ–Ω–∞ –æ—Ç <input type="number" id="priceMin"></label>
          <label>–¶–µ–Ω–∞ –¥–æ <input type="number" id="priceMax"></label>
          <label>–í–∞–ª—é—Ç–∞ <input id="currency" value="‚ÇΩ"></label>
        </div>
        <label>–ù—É–∂–Ω–∞ –ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è?</label>
        <select id="needReg">
          <option value="no">–ù–µ—Ç</option>
          <option value="yes">–î–∞</option>
        </select>
        <div class="actions">
          <button type="button" class="secondary" onclick="prevStep()">–ù–∞–∑–∞–¥</button>
          <button type="button" onclick="nextStep()">–î–∞–ª–µ–µ</button>
        </div>
      `,
        () => `
        <small> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è</small>
        ${generateTypeSpecific()}
        `,
        () => `
        <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
        <div class="preview">${previewHTML()}</div>

        <div class="actions">
          <button type="button" class="secondary" onclick="prevStep()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
          <button type="button" onclick="submitEvent()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
      `,
      ];

      function renderStep() {
        form.innerHTML = stepTemplates[current]();
        steps.forEach((s, i) => s.classList.toggle("active", i === current));
      }

      function nextStep() {
        saveData();
        if (current < stepTemplates.length - 1) current++;
        renderStep();
      }
      function prevStep() {
        if (current > 0) current--;
        renderStep();
      }

      function saveData() {
        if (current === 0) {
          eventData.type = eventData.type || "";
          eventData.title =
            document.getElementById("title")?.value || eventData.title;
        }
        if (current === 1) {
          eventData.start = document.getElementById("start").value;
          eventData.end = document.getElementById("end").value;
          eventData.duration = document.getElementById("duration").value;
        }
        if (current === 2)
        {
          eventData.place = document.getElementById("place").value;
        }
        if (current === 3) {
          eventData.priceType = document.getElementById("priceType").value;
          if (eventData.priceType === "paid") {
            eventData.priceMin = document.getElementById("priceMin").value;
            eventData.priceMax = document.getElementById("priceMax").value;
            eventData.currency = document.getElementById("currency").value;
          }
          eventData.needReg =
            document.getElementById("needReg").value === "yes";
        }
        if (current === 4) {
          const fields = document.querySelectorAll("[data-field]");
          eventData.details = {};
          fields.forEach(
            (f) =>
              (eventData.details[f.dataset.field] =
                f.type === "checkbox" ? f.checked : f.value)
          );
        }
      }

      function selectType(t, btn) {
        eventData.type = t;
        document
          .querySelectorAll(".grid button")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
      }
      function togglePrice() {
        document.getElementById("priceFields").style.display =
          document.getElementById("priceType").value === "paid"
            ? "block"
            : "none";
      }

      function generateTypeSpecific() {
        const t = eventData.type;
        let html = `<h3>–î–µ—Ç–∞–ª–∏ (${t || "—Ç–∏–ø –Ω–µ –≤—ã–±—Ä–∞–Ω"})</h3>`;
        const fields = [];
        if (["–ö–æ–Ω—Ü–µ—Ä—Ç", "–¢–µ–∞—Ç—Ä", "–ö–∏–Ω–æ"].includes(t)) {
          fields.push(["–í–æ–∑—Ä–∞—Å—Ç (0+,12+,18+)", "age", "text"]);
          fields.push(["–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)", "duration", "number"]);
          fields.push(["–§–æ—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ?", "photo", "checkbox"]);
        } else if (["–õ–µ–∫—Ü–∏—è", "–í–æ—Ä–∫—à–æ–ø"].includes(t)) {
          fields.push(["–£—Ä–æ–≤–µ–Ω—å", "level", "text"]);
          fields.push(["–ß—Ç–æ –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π", "things", "text"]);
        } else if (t === "–°–ø–æ—Ä—Ç") {
          fields.push(["–£—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏", "skill", "text"]);
          fields.push(["–ù—É–∂–Ω–∞ —Ñ–æ—Ä–º–∞/–æ–±—É–≤—å?", "gear", "checkbox"]);
        } else if (t === "–î–µ—Ç—Å–∫–æ–µ") {
          fields.push(["–í–æ–∑—Ä–∞—Å—Ç (3‚Äì7)", "ageRange", "text"]);
          fields.push(["–ù—É–∂–µ–Ω –≤–∑—Ä–æ—Å–ª—ã–π?", "adult", "checkbox"]);
        } else if (["–§–µ—Å—Ç–∏–≤–∞–ª—å", "–Ø—Ä–º–∞—Ä–∫–∞"].includes(t)) {
          fields.push(["–ù–∞ —É–ª–∏—Ü–µ?", "outdoor", "checkbox"]);
          fields.push(["–ü—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–∏ –¥–æ–∂–¥–µ?", "rain", "checkbox"]);
        }
        html += fields
          .map(
            ([label, key, type]) =>
              `<label>${label} ${
                type === "checkbox"
                  ? `<input type="checkbox" data-field="${key}">`
                  : `<input type="${type}" data-field="${key}">`
              }</label>`
          )
          .join("");
        html += `
        <div class="actions"><button type="button" class="secondary" onclick="prevStep()">–ù–∞–∑–∞–¥</button>
        <button type="button" onclick="nextStep()">–î–∞–ª–µ–µ</button></div>`;
        return html;
      }

      function previewHTML() {
        return `<strong>${eventData.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</strong><br>–¢–∏–ø: ${
          eventData.type || "‚Äî"
        }<br>${
          eventData.start
            ? new Date(eventData.start).toLocaleString("ru-RU")
            : ""
        }<br>–ú–µ—Å—Ç–æ: ${eventData.place || ""}<br>${
          eventData.priceType === "free"
            ? "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ"
            : `–¶–µ–Ω–∞: ${eventData.priceMin || ""}-${eventData.priceMax || ""}${
                eventData.currency || ""
              }`
        }<br>${eventData.needReg ? "–ù—É–∂–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" : ""}`;
      }

      async function submitEvent() {
        saveData();
        try {
          const res = await fetch("http://localhost:8080/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(eventData),
          });
          const data = await res.json();
          alert("–°–æ–±—ã—Ç–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ! ID: " + (data.id || "‚Äî"));
        } catch (e) {
          alert("–û—à–∏–±–∫–∞: " + e.message);
        }
      }

      // --- —Ñ–∏–¥–±–µ–∫ ---
      function openFeedback(step) {
        modalStep.textContent = step;
        modal.classList.add("active");
      }
      function closeFeedback() {
        modal.classList.remove("active");
        document.getElementById("feedbackText").value = "";
        document.getElementById("feedbackEmail").value = "";
      }
      async function sendFeedback() {
        const text = document.getElementById("feedbackText").value.trim();
        const email = document.getElementById("feedbackEmail").value.trim();
        if (!text) {
          alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞");
          return;
        }
        const payload = { step: current + 1, text, email };
        try {
          await fetch("http://localhost:8080/feedback", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          alert("‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!");
          closeFeedback();
        } catch (e) {
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ");
        }
      }

      renderStep();
    </script>
  </body>
</html>
